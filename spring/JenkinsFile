pipeline {
    agent any
    
    stages {
        stage('Build') {
            steps {
                bat '''
                    cd spring
                    echo Building Spring Boot application...
                    mvn clean package -DskipTests
                    
                    echo Build completed! JAR file created:
                    dir target\\*.jar
                '''
            }
        }
        
        stage('Stop Previous App') {
            steps {
                bat '''
                    echo Checking for running Spring Boot applications...
                    for /f "tokens=2" %%i in ('tasklist /FI "IMAGENAME eq java.exe" /FO CSV ^| findstr "java.exe"') do (
                        echo Found Java process: %%i
                        taskkill /F /PID %%i 2>nul || echo Could not kill process %%i
                    )
                    
                    echo Waiting for cleanup...
                    ping 127.0.0.1 -n 6 > nul
                '''
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    dir('spring') {
                        bat '''
                            echo Deploying Spring Boot application...
                            
                            REM Create a simple batch script to run the app
                            echo @echo off > start_app.bat
                            echo cd /d "%cd%" >> start_app.bat
                            echo java -jar target\\spring-0.0.1-SNAPSHOT.jar >> start_app.bat
                            
                            REM Start the application in a separate window
                            start "SpringBoot App" cmd /c start_app.bat
                            
                            echo Application deployment script created and started!
                        '''
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                bat '''
                    echo Waiting for application to start...
                    ping 127.0.0.1 -n 16 > nul
                    
                    echo Checking for Java processes:
                    tasklist | findstr java.exe || echo No Java processes found
                    
                    echo Testing application endpoints:
                    curl -m 10 http://localhost:8080/ || echo Root endpoint not ready
                    curl -m 10 http://localhost:8080/hello || echo Hello endpoint not ready
                    
                    echo Health check completed!
                '''
            }
        }
    }
    
    post {
        success {
            echo 'Deployment pipeline completed successfully!'
            echo 'Your Spring Boot app should be running on http://localhost:8080'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
        always {
            echo 'Cleaning up temporary files...'
            bat '''
                cd spring
                if exist start_app.bat del start_app.bat
            '''
        }
    }
}
