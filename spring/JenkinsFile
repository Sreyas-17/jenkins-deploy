pipeline {
    agent any
    
    stages {
        stage('Verify Environment') {
            steps {
                bat '''
                    echo Current directory:
                    cd
                    
                    echo Java version:
                    java -version
                    
                    echo Listing root files:
                    dir
                '''
            }
        }
        
        stage('Navigate and Build') {
            steps {
                bat '''
                    echo Navigating to spring directory:
                    cd spring
                    
                    echo Listing spring directory:
                    dir
                    
                    echo Building with Maven wrapper:
                    mvnw.cmd clean package -DskipTests
                '''
            }
        }
        
        stage('Deploy') {
            steps {
                bat '''
                    cd spring
                    
                    echo Stopping existing application:
                    taskkill /F /IM java.exe 2>nul || echo No existing Java process found
                    
                    timeout /t 3 /nobreak >nul
                    
                    echo Checking for JAR file:
                    dir target\\*.jar
                    
                    echo Starting Spring Boot application:
                    for %%f in (target\\*.jar) do (
                        echo Starting: %%f
                        start /B java -jar %%f
                    )
                    
                    echo Waiting for application startup:
                    timeout /t 20 /nobreak >nul
                '''
            }
        }
        
        stage('Health Check') {
            steps {
                bat '''
                    echo Testing application:
                    
                    REM List Java processes
                    tasklist | findstr java || echo No Java processes found
                    
                    REM Test endpoints (might fail if app is still starting)
                    curl http://localhost:8080/ || echo Testing root endpoint...
                    curl http://localhost:8080/hello || echo Testing hello endpoint...
                    
                    echo Health check completed!
                '''
            }
        }
    }
    
    post {
        success {
            echo 'Spring Boot application deployed successfully!'
        }
        failure {
            echo 'Deployment failed. Check the logs above.'
        }
    }
}
