pipeline {
    agent any
    
    tools {
        maven 'Maven-3.8.1'
        jdk 'JDK-11'
    }
    
    environment {
        JAVA_HOME = tool('JDK-11')
        PATH = "${tool('JDK-11')}\\bin;${tool('Maven-3.8.1')}\\bin;${env.PATH}"
    }
    
    stages {
        stage('Verify Environment') {
            steps {
                bat '''
                    echo Java Home: %JAVA_HOME%
                    echo.
                    echo Java Version:
                    "%JAVA_HOME%\\bin\\java" -version
                    echo.
                    echo Maven Version:
                    "%JAVA_HOME%\\bin\\java" -version 2>&1 | findstr "version"
                    mvn -version
                '''
            }
        }
        
        stage('Build') {
            steps {
                bat '''
                    echo Building with Maven...
                    mvn clean package -DskipTests
                '''
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    bat '''
                        echo Starting deployment...
                        
                        REM Kill existing Java processes (ignore errors)
                        taskkill /F /IM java.exe 2>nul || echo No existing Java process found
                        
                        REM Wait a moment
                        timeout /t 3 /nobreak >nul
                        
                        REM Find the JAR file
                        for %%f in (target\\*.jar) do set JAR_FILE=%%f
                        echo Starting application: %JAR_FILE%
                        
                        REM Start the application using the correct Java
                        start /B "%JAVA_HOME%\\bin\\java" -jar %JAR_FILE%
                        
                        REM Wait for startup
                        echo Waiting for application to start...
                        timeout /t 20 /nobreak >nul
                        
                        echo Deployment completed!
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    bat '''
                        echo Testing application endpoints...
                        
                        REM Check if process is running
                        tasklist | findstr java || echo No Java process found
                        
                        REM Try to access the application
                        curl http://localhost:8080/hello || echo Application may still be starting...
                        
                        echo Health check completed!
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed! Check the logs above.'
        }
    }
}
