pipeline {
    agent any
    
    tools {
        maven 'Maven-3.8.1'
        jdk 'JDK-11'
    }
    
    environment {
        JAVA_HOME = tool('JDK-11')
        PATH = "${JAVA_HOME}\\bin;${env.PATH}"
    }
    
    stages {
        stage('Verify Environment') {
            steps {
                bat '''
                    echo Java Home: %JAVA_HOME%
                    echo Path: %PATH%
                    java -version
                    mvn -version
                '''
            }
        }
        
        stage('Build') {
            steps {
                bat 'mvn clean package -DskipTests'
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    bat '''
                        REM Kill existing Java processes (ignore errors)
                        taskkill /F /IM java.exe 2>nul || echo No existing Java process found
                        
                        REM Wait a moment
                        timeout /t 3 /nobreak >nul
                        
                        REM Find the JAR file
                        for %%f in (target\\*.jar) do set JAR_FILE=%%f
                        echo Starting application: %JAR_FILE%
                        
                        REM Start the application in background
                        start /B java -jar %JAR_FILE%
                        
                        REM Wait for startup
                        echo Waiting for application to start...
                        timeout /t 20 /nobreak >nul
                        
                        echo Deployment completed!
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    bat '''
                        echo Testing application endpoints...
                        
                        REM Try to access the application (may fail initially)
                        curl http://localhost:8080/hello || echo Application may still be starting...
                        
                        echo Health check completed!
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed! Check the logs above.'
        }
    }
}
