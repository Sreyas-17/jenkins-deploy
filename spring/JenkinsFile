pipeline {
    agent any
    
    stages {
        stage('Verify Environment') {
            steps {
                bat '''
                    echo Current directory:
                    cd
                    
                    echo Java version:
                    java -version
                    
                    echo Maven version:
                    mvn -version
                '''
            }
        }
        
        stage('Navigate and Build') {
            steps {
                bat '''
                    cd spring
                    echo Building with system Maven:
                    mvn clean package -DskipTests
                '''
            }
        }
        
        stage('Deploy') {
            steps {
                bat '''
                    cd spring
                    
                    echo Stopping existing application:
                    taskkill /F /IM java.exe 2>nul || echo No existing Java process found
                    
                    echo Waiting 3 seconds...
                    ping 127.0.0.1 -n 4 > nul
                    
                    echo Checking for JAR file:
                    dir target\\*.jar
                    
                    echo Starting Spring Boot application:
                    for %%f in (target\\*.jar) do (
                        echo Starting: %%f
                        start /B java -jar %%f
                    )
                    
                    echo Waiting for application startup...
                    ping 127.0.0.1 -n 21 > nul
                '''
            }
        }
        
        stage('Health Check') {
            steps {
                bat '''
                    echo Testing application:
                    
                    echo Checking Java processes:
                    tasklist | findstr java || echo No Java processes found
                    
                    echo Testing endpoints:
                    curl http://localhost:8080/ || echo Root endpoint test failed
                    curl http://localhost:8080/hello || echo Hello endpoint test failed
                    
                    echo Health check completed!
                '''
            }
        }
    }
    
    post {
        success {
            echo 'Spring Boot application deployed successfully!'
        }
        failure {
            echo 'Deployment failed. Check the logs above.'
        }
    }
}
